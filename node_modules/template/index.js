/*
 * 模拟jade语法，但基于html的模板引擎
 * */

exports.render = function (tpl) {
    function escape(html) {
        var result = String(html)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
        return result === '' + html ? html : result;
    }

    var compileStr = escape.toString() + ';var echo=\'\';' +
        tpl.split(/[\r\n]/gm).map(function (item) {

            if (/^[\s]*-(.+)$/.test(item)) {
                return RegExp.$1
            }

            // 1：将标识符：#{ } !{}，查询并解析出来，保存到map变量中，并用prefix变量进行替换，index指定是第几个标识符
            var map = {}, index = 0, prefix = '¶SQ_JG_MGJ_' + (Math.random() + '').substring(2) + '¶'
            item = item.replace(/(\\)*?([!#])\{([^}]+?)\}/g, function (a, b, c, d) {
                if (b !== undefined) return a
                map[(++index)] = '\'+' + (c === '#' ? 'escape' : '') + '(' + (d ? d.replace(/\\'/g, '\'') : "''") + ')+\''
                return prefix + index
            })
            // 2：进行单引号和双引号转义
            item = 'echo+=(\'' + item.replace(/('|\\)/g, '\\$1') + '\\r\\n\')'
            // 3：将标识符从map中再替换回来
            for (var k in map) item = item.replace(prefix + k, map[k])
            return item
        }).join('\r\n')
    return compileStr += ';return echo;'
}
